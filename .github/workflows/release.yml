name: Release Build

on:
  push:
    branches: [ "master", "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
            toolchain: stable
            target: x86_64-pc-windows-msvc

      - name: Install cargo-chef and cargo-wix
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-chef,cargo-wix

      - name: VCPKG Cache
        uses: actions/cache@v4
        with:
          path: vcpkg_installed
          key: ${{ runner.os }}-vcpkg-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgJsonGlob: 'vcpkg.json'
          runVcpkgInstall: true

      - name: Cargo Chef Prepare
        run: cargo chef prepare --recipe-path recipe.json

      - name: Cargo Chef Cache
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-chef-${{ hashFiles('recipe.json') }}

      - name: Cargo Chef Cook
        run: |
          $env:VCPKG_ROOT = "${{ github.workspace }}\vcpkg"
          cargo chef cook --release --recipe-path recipe.json --target x86_64-pc-windows-msvc --features libtorrent --no-default-features
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKGRS_TRIPLET: x64-windows-static

      - name: Restore Source Code
        run: git restore server enginefs libtorrent-sys

      - name: Build Release
        run: |
          cargo clean -p server --release
          cargo build --release --target x86_64-pc-windows-msvc --features libtorrent --no-default-features
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKGRS_TRIPLET: x64-windows-static

      - name: Upload EXE
        uses: actions/upload-artifact@v4
        with:
          name: server-windows-amd64
          path: target/x86_64-pc-windows-msvc/release/server.exe

      - name: Initialize WiX
        run: cargo wix init --package server --force
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKGRS_TRIPLET: x64-windows-static

      - name: Build MSI Installer
        run: cargo wix --package server --no-build --nocapture --target x86_64-pc-windows-msvc
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
          VCPKGRS_TRIPLET: x64-windows-static


      - name: Upload MSI
        uses: actions/upload-artifact@v4
        with:
          name: server-windows-msi
          path: target/wix/*.msi

      - name: Debug VCPKG Location
        if: always()
        run: |
          Get-ChildItem -Path . -Force
          if (Test-Path vcpkg) { Get-ChildItem -Path vcpkg -Force }
          if (Test-Path vcpkg_installed) { Get-ChildItem -Path vcpkg_installed -Force }

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-chef and cargo-deb
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-chef,cargo-deb

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config libssl-dev libfuse2

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '84bab45d415d22042bd0b9081aea57f362da3f35'
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgJsonGlob: 'vcpkg.json'
          runVcpkgInstall: true

      - name: Cargo Chef Prepare
        run: cargo chef prepare --recipe-path recipe.json

      - name: Cargo Chef Cache
        uses: actions/cache@v4
        with:
          path: |
            target
            vcpkg_installed
          key: ${{ runner.os }}-cargo-chef-${{ hashFiles('recipe.json') }}

      - name: Cargo Chef Cook
        run: |
           export VCPKG_ROOT=${{ github.workspace }}/vcpkg
           cargo chef cook --release --recipe-path recipe.json --features libtorrent --no-default-features
        env:
           VCPKG_ROOT: ${{ github.workspace }}/vcpkg

      - name: Restore Source Code
        run: git restore server enginefs libtorrent-sys

      - name: Build Release
        run: cargo build --release --features libtorrent --no-default-features
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg

      - name: Build DEB Package
        run: cargo deb --package server --no-build
        env:
          VCPKG_ROOT: ${{ github.workspace }}/vcpkg

      - name: Build AppImage
        run: |
          # Download linuxdeploy
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # Create AppDir structure
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps

          # Copy binary
          cp target/release/server AppDir/usr/bin/stream-server

          # Create desktop file
          cat > AppDir/usr/share/applications/stream-server.desktop << EOF
          [Desktop Entry]
          Type=Application
          Name=Stream Server
          Exec=stream-server
          Icon=stream-server
          Categories=Network;
          EOF

          # Create simple icon (placeholder)
          convert -size 256x256 xc:steelblue -gravity center -pointsize 48 -fill white -annotate 0 "SS" AppDir/usr/share/icons/hicolor/256x256/apps/stream-server.png || echo "ImageMagick not available, using placeholder"

          # Build AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage || true

      - name: Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: server-linux-amd64
          path: target/release/server

      - name: Upload DEB
        uses: actions/upload-artifact@v4
        with:
          name: server-linux-deb
          path: target/debian/*.deb

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: server-linux-appimage
          path: "*.AppImage"
          if-no-files-found: ignore

  build-arch:
    name: Build Arch Linux
    runs-on: ubuntu-latest
    container: archlinux:latest
    steps:
      - uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel rust git openssl pkg-config libtorrent-rasterbar boost

      - name: Cargo Cache
        uses: actions/cache@v4
        with:
          path: |
            target
            /root/.cargo/registry
            /root/.cargo/git
          key: arch-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            arch-cargo-

      - name: Build binary
        run: cargo build --release --features libtorrent --no-default-features
        env:
          VCPKG_ROOT: ""

      - name: Create PKGBUILD
        run: |
          mkdir -p pkg
          cat > pkg/PKGBUILD << 'EOF'
          # Maintainer: stream-server maintainers
          pkgname=stream-server
          pkgver=0.1.0
          pkgrel=1
          pkgdesc="High-performance torrent streaming server with HLS transcoding"
          arch=('x86_64')
          url="https://github.com/perpetus/stream-server"
          license=('MIT')
          depends=('openssl' 'libtorrent-rasterbar' 'boost-libs')
          source=("stream-server")
          sha256sums=('SKIP')

          package() {
              install -Dm755 "$srcdir/stream-server" "$pkgdir/usr/bin/stream-server"
          }
          EOF

          cp target/release/server pkg/stream-server

      - name: Build package
        run: |
          cd pkg
          # Create non-root user for makepkg
          useradd -m builder
          chown -R builder:builder .
          su builder -c "makepkg -sf --noconfirm"

      - name: Upload Arch Package
        uses: actions/upload-artifact@v4
        with:
          name: server-arch-pkg
          path: pkg/*.pkg.tar.zst

  release:
    name: Create Release
    needs: [build-windows, build-linux, build-arch]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          # Windows
          cp artifacts/server-windows-amd64/server.exe release/stream-server-windows-amd64.exe || true
          cp artifacts/server-windows-msi/*.msi release/ || true
          # Linux
          cp artifacts/server-linux-amd64/server release/stream-server-linux-amd64 || true
          cp artifacts/server-linux-deb/*.deb release/ || true
          cp artifacts/server-linux-appimage/*.AppImage release/ || true
          # Arch
          cp artifacts/server-arch-pkg/*.pkg.tar.zst release/ || true
          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
